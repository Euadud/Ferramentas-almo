<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Ferramentas ‚Äì Dashboard + Colaboradores (Excel)</title>

<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --primary:#0b63d6;
    --primary-dark:#064a9d;
    --success:#28a745;
    --bg:#f4f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --shadow: 0 8px 30px rgba(9,30,66,0.08);
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg),#eef4fb 60%);
    color:#0f1724;
    display:flex;
    justify-content:center;
    min-height:100vh;
  }

  .wrap{width:1200px;margin:28px auto;padding:20px;}

  /* LOGIN */
  .login {
    max-width:420px;margin:80px auto;padding:28px;background:var(--card);border-radius:12px;
    box-shadow:var(--shadow);text-align:center;
  }
  .login h2{margin:0 0 12px;font-size:22px;color:var(--primary)}
  .login input{
    width:100%;padding:12px;margin:10px 0;border:1px solid #e1e6ef;border-radius:10px;font-size:15px;
  }
  .btn{padding:11px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:white}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}

  /* LAYOUT PRINCIPAL */
  .layout{display:flex;gap:20px}
  .sidebar{width:260px;background:var(--card);padding:20px;border-radius:12px;box-shadow:var(--shadow);height:calc(100vh - 56px);position:sticky;top:20px}
  .sidebar h3{margin-top:0;color:var(--primary);font-size:18px}
  .sidebar button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:10px;font-weight:700;cursor:pointer;background:var(--primary);color:white}

  .content{flex:1}

  .header{
    background:linear-gradient(90deg,var(--primary),var(--primary-dark));
    color:white;padding:18px;border-radius:12px;margin-bottom:18px;box-shadow:var(--shadow);
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .search {
    flex:1;min-width:240px;padding:12px;border-radius:10px;border:1px solid #e1e6ef;background:var(--card);
    font-size:15px;
  }
  .action-btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn-green{background:var(--success);color:white}
  .btn-add{background:var(--primary);color:white}
  .btn-warning{background:#f59e0b;color:white}

  .panel{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow);}

  table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden;margin-top:8px}
  th,td{padding:12px 10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;vertical-align:middle}
  th{background:#f7fafc;color:#55607a;font-weight:700}
  td[contenteditable="true"]{background:#fbfdff}
  td.center{ text-align:center; }

  .footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:right}

  /* COLABORADORES */
  #colaboradoresBox{display:none;max-height:70vh;overflow:auto}
  #colaboradoresBox input{width:100%;padding:12px;margin:10px 0;border:1px solid #e1e6ef;border-radius:10px;font-size:15px}
  .col-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid #edf1f7}
  .col-item img{width:44px;height:44px;border-radius:8px;object-fit:cover;margin-right:12px}
  .col-actions{margin-left:auto;display:flex;gap:8px}
  .small-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .btn-danger{background:var(--danger);color:white}
  .btn-muted{background:#e6eef6;color:#0f1724}

  /* MODAL */
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:white;padding:18px;border-radius:12px;max-width:520px;width:92%;box-shadow:var(--shadow)}
  .modal input, .modal select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6edf6}

  /* responsive */
  @media(max-width:1000px){
    .wrap{width:95%}
    .sidebar{display:none}
  }
</style>
</head>
<body>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginBox" class="login" >
    <h2>Entrar - Sistema de Invent√°rio</h2>
    <input id="email" type="email" placeholder="Usu√°rio" autocomplete="username" />
    <input id="senha" type="password" placeholder="Senha" autocomplete="current-password" />
    <button class="btn btn-primary" onclick="login()">Entrar</button>
    <p id="loginErro" class="muted"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" style="display:none">

    <div class="layout">

      <div class="sidebar">
        <h3>Menu</h3>
        <button onclick="abrirInventario()">Invent√°rio</button>
        <button onclick="abrirColaboradores()">Colaboradores</button>

        <!-- Excel no menu (Option A texts as requested) -->
        <button style="background:#6b7280;margin-top:12px" onclick="exportarExcel()">Exportar Itens (Excel)</button>
        <button style="background:#6b7280;margin-top:8px" onclick="triggerImport()">Importar Itens (Excel)</button>

        <div style="margin-top:18px" class="muted">
          Abra "Colaboradores" para adicionar nome, foto e √°rea. Eles aparecer√£o no campo "Para quem?".
        </div>

        <div style="margin-top:20px">
          <button style="background:#e6eef6;color:#0f1724" onclick="exportarTudo()">Exportar tudo (JSON)</button>
          <button style="margin-top:8px;background:#f59e0b;color:white" onclick="importarPrompt()">Importar itens (JSON)</button>
        </div>
      </div>

      <div class="content">

        <div id="inventarioBox">
          <div class="header">
            <h1>Controle de Ferramentas ‚Äì Oficina</h1>
            <div class="controls">
              <input id="buscar" class="search" placeholder="Buscar item..." oninput="buscarItem()" />
              <button class="action-btn btn-add" onclick="abrirModalAdd()">+ Adicionar Pe√ßa</button>
              <button class="action-btn btn-warning" onclick="devolverSelecionados()">Marcar como devolvido</button>
              <button class="action-btn btn-green" onclick="salvar()">Salvar</button>
            </div>
          </div>

          <div class="panel">
            <table id="tabela">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Qtd</th>
                  <th>Emprestado?</th>
                  <th>Para quem?</th>
                  <th>Data Empr√©stimo</th>
                  <th>Data Devolu√ß√£o</th>
                  <th>Devolvido?</th>
                  <th>Excluir</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="small-btn btn-muted" onclick="exportarExcel()">Exportar Itens (Excel)</button>
              <button class="small-btn" onclick="triggerImport()">Importar Itens (Excel)</button>
              <button class="small-btn" onclick="limparItens()" style="background:#f59e0b;color:white">Limpar Itens</button>
            </div>

            <div class="footer">Sistema local ‚Äî tudo salvo no navegador.</div>
          </div>
        </div>

        <!-- COLABORADORES -->
        <div id="colaboradoresBox">
          <div class="header" style="margin-bottom:10px">
            <h2>Gerenciar Colaboradores</h2>
          </div>

          <div id="colabForm" class="panel" style="margin-bottom:12px">
            <input id="colabNome" placeholder="Nome" />
            <input id="colabArea" placeholder="√Årea (ex: Mec√¢nica, Expedi√ß√£o)" />
            <input id="colabFoto" type="file" accept="image/*" />
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary" onclick="salvarColaborador()">Salvar Colaborador</button>
              <button class="btn" onclick="limparFormColab()">Limpar</button>
            </div>
          </div>

          <div id="colaboradoresBoxInner" class="panel">
            <h3>Lista de Colaboradores</h3>
            <div id="colaboradoresLista"></div>

            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="small-btn btn-muted" onclick="exportarColabs()">Exportar Colaboradores (JSON)</button>
              <button class="small-btn" onclick="importarColabsPrompt()">Importar Colaboradores (JSON)</button>
              <button class="small-btn btn-danger" onclick="limparColabs()">Limpar todos</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- MODAL ADICIONAR PE√áA -->
<div id="modal" class="modal-backdrop">
  <div class="modal">
    <h3>Adicionar Pe√ßa</h3>
    <input id="inpItem" placeholder="Nome do item (ex: Chave 10mm)" />
    <input id="inpQtd" placeholder="Quantidade" type="number" min="1" />
    <label style="margin-top:8px;font-size:13px;color:var(--muted)">Emprestado?</label>
    <select id="inpEmprestado">
      <option>N√£o</option>
      <option>Sim</option>
    </select>
    <label style="margin-top:8px;font-size:13px;color:var(--muted)">Para quem?</label>
    <select id="inpParaQuem"><option value=""></option></select>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-primary" onclick="adicionarPe√ßa()">Adicionar</button>
      <button class="btn" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Hidden file input for Excel import -->
<input id="importExcelFile" type="file" accept=".xlsx" style="display:none" />
<script>
/* -----------------------
   Config de login
   ----------------------- */
const USR = "Fernando@flapa";
const PWD = "flapa@2025";

/* -----------------------
   Bancos locais
   - itens: array de arrays [nome,qtd,emprestado,paraquem,dataEmprestimo,dataDevolucao,devolvido]
   - colaboradores: array de objetos {name,photo,area}
   ----------------------- */
let itens = [
  ["SACA POLIA COMPLETO",1,"N√£o",""],
  ["PARAFUSADEIRA ELETRICA 1/2",1,"N√£o",""],
  ["SUBITO",1,"N√£o",""],
  ["KIT CARGA DE NITROGENIO",1,"N√£o",""],
  ["ET CATERPILLAR",1,"N√£o",""],
  ["TESTADOR DE BATERIA",1,"N√£o",""],
  ["ENCOLHEDOR DE MOLAS",1,"N√£o",""],
  ["BASE MAGNETICA",3,"N√£o",""],
  ["BOMBA DE VACUO",2,"N√£o",""],
  ["BASE DE RELOGIO COMPARADOR",1,"N√£o",""],
  ["GABARITO DE SERVO DE EMBREAGEM",1,"N√£o",""],
  ["MEDIDOR DE √ÇNGULO DE GRAU",1,"N√£o",""],
  ["BALAN√áA DIGITAL",1,"N√£o",""],
  ["TRANSFERIDOR DE GRAU",1,"N√£o",""],
  ["DECIMETRO",1,"N√£o",""],
  ["PARAFUSADEIRA ELETRICA",1,"N√£o",""],
  ["BATERIA RESERVA FURADEIRA",2,"N√£o",""],
  ["CARREGADOR DE BATERIA DA PARAFUSADEIRA",1,"N√£o",""],
  ["MICROMETRO",2,"N√£o",""],
  ["TACOMETRO",1,"N√£o",""],
  ["MEDIDOR DE INJETOR",1,"N√£o",""],
  ["TRANSFERIDOR",1,"N√£o",""],
  ["REGUA DE NIVEL",1,"N√£o",""],
  ["RELOGIO COMPARADOR",1,"N√£o",""],
  ["BOMBA DE GRAXA MANUAL",3,"N√£o",""],
  ["MULTIPLICADOR DE TORQUE",1,"N√£o",""],
  ["TORQUIMETRO",12,"N√£o",""],
  ["CHAVE DE GRIFO",2,"N√£o",""],
  ["MANOMETRO DIGITAL",1,"N√£o",""],
  ["TERMOFUSORA",1,"N√£o",""],
  ["ESCALA COM GANCHO",1,"N√£o",""],
  ["CHAVE SEXTAAVADA MANUAL",1,"N√£o",""],
  ["EXTRATOR PNEUMATICO VOLVO",1,"N√£o",""],
  ["MARRETA DE BRONZE",1,"N√£o",""],
  ["JOGO SOQUETE 3/4",1,"N√£o",""],
  ["SANGRIA DE FREIO ELETRICO",1,"N√£o",""],
  ["GABARITO DE FREIO VOLVO",1,"N√£o",""],
  ["CHAVE DE CORTAR FILTRO",2,"N√£o",""],
  ["ANILHA 1 POLEGADA DE 3/4",1,"N√£o",""],
  ["ILHOS DE 6 TONELADAS",2,"N√£o",""],
  ["ILHOS DE 4 TONELADAS",2,"N√£o",""],
  ["VENTOSA",1,"N√£o",""],
  ["SACA ROLAMENTO UNIVERSAL",1,"N√£o",""],
  ["EXTRATOR DE PINO DE DIRE√á√ÉO",3,"N√£o",""],
  ["SACA POLIA DE 3 GARRAS",2,"N√£o",""],
  ["SACA POLIA DE 2 GARRAS",1,"N√£o",""],
  ["CHAVE DE PORCA REDONDA",1,"N√£o",""],
  ["CHAVE OITAVADA 80MM",1,"N√£o",""],
  ["SOQUETE SEXTAVADO 100MM",1,"N√£o",""],
  ["SOQUETE OITAVADO 115MM",1,"N√£o",""],
  ["COCINETE",1,"N√£o",""],
  ["PILOTO GUIA",1,"N√£o",""],
  ["SOQUETE PARA PORCA CASTELA",1,"N√£o",""],
  ["CHAVE PORCA DE CUBO MERCED BENZ",1,"N√£o",""],
  ["PINHAO DE GIRAR MOTOR",3,"N√£o",""],
  ["SOQUETE DE IMPACTO 41",1,"N√£o",""],
  ["SOQUETE DE IMPACTO 34",1,"N√£o",""],
  ["SOQUETE DE IMPACTO 38",1,"N√£o",""],
  ["SOQUETE DE IMPACTO 33",1,"N√£o",""],
  ["ALICATE DE TRAVA",6,"N√£o",""],
  ["TURQUEZA",1,"N√£o",""],
  ["CHAVE DE CABINE VOLVO",1,"N√£o",""],
  ["SOQUETE 28MM",1,"N√£o",""],
  ["ALICATE DE ANEL DE PISTAO",1,"N√£o",""],
  ["COMPASSO",1,"N√£o",""],
  ["KIT MANOMETRO",1,"N√£o",""],
  ["ALICATE DE CRIMPAR",1,"N√£o",""],
  ["MARTELO DE BORRACHA",1,"N√£o",""],
  ["RETIFICA PNEUMATICA",2,"N√£o",""],
  ["FURADEIRA DE BATERIA",1,"N√£o",""],
  ["KIT DE LIXAGEM ROTATIVA",1,"N√£o",""],
  ["JOGO DE SOQUETE DE 1/2",1,"N√£o",""],
  ["PARAFUSADEIRA ELETRICA DE 3/4",2,"N√£o",""],
  ["TESTE RADIADOR",1,"N√£o",""],
  ["INFRARED",4,"N√£o",""],
  ["PRENSA CABO",1,"N√£o",""],
  ["VAZADOR",1,"N√£o",""],
  ["REBITADOR",1,"N√£o",""],
  ["ESMIRILHADEIRA",1,"N√£o",""],
  ["CINTA DE ANEL DE PISTAO",1,"N√£o",""],
  ["MANGUEIRA DE DRENO",1,"N√£o",""],
  ["SERROTE",1,"N√£o",""],
  ["DENSADOR UNIVERSAL",1,"N√£o",""]
];
let colaboradores = JSON.parse(localStorage.getItem("colaboradoresSistema") || "[]");


/* --------- LOGIN --------- */
function login(){
  const e = document.getElementById('email').value.trim();
  const s = document.getElementById('senha').value;

  // normaliza email (case-insensitive) and exact password
  if (e.toLowerCase() === USR.toLowerCase() && s === PWD) {
    document.getElementById('loginBox').style.display = "none";
    document.getElementById('dashboard').style.display = "block";
    abrirInventario();
    carregarColaboradores();
    carregarTabela();
  } else {
    document.getElementById('loginErro').innerText = "Usu√°rio ou senha incorretos.";
  }
}

/* --------- NAV (inventario / colaboradores) --------- */
function abrirInventario(){ document.getElementById('inventarioBox').style.display = "block"; document.getElementById('colaboradoresBox').style.display = "none"; }
function abrirColaboradores(){ document.getElementById('inventarioBox').style.display = "none"; document.getElementById('colaboradoresBox').style.display = "block"; carregarColaboradores(); }

/* -----------------------
   INVENT√ÅRIO
   ----------------------- */

function salvar(){
  localStorage.setItem("inventarioFerramentas", JSON.stringify(itens));
  alert("Itens salvos!");
}

function carregarTabela(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  itens.forEach((item, i) => {
    // preenche op√ß√µes de colaboradores no select
    const options = colaboradores.map(c => `<option ${item[3] === c.name ? "selected" : ""}>${c.name}</option>`).join("");

    // garantir que item exista
    const nome = item[0] ?? "";
    const qtd  = item[1] ?? "";
    const emprestado = item[2] ?? "N√£o";
    const paraquem = item[3] ?? "";
    const dataEmp = item[4] ?? "";
    const dataDev = item[5] ?? "";
    const devolvido = item[6] ?? "N√£o";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td contenteditable="true" oninput="editar(${i},0,this.innerText)">${nome}</td>
      <td contenteditable="true" oninput="editar(${i},1,this.innerText)">${qtd}</td>

      <td>
        <select onchange="trocarEmprestado(${i},this.value)">
          <option ${emprestado=="N√£o"?"selected":""}>N√£o</option>
          <option ${emprestado=="Sim"?"selected":""}>Sim</option>
        </select>
      </td>

      <td>
        <select onchange="editar(${i},3,this.value)">
          <option value=""></option>
          ${options}
        </select>
      </td>

      <td contenteditable="true" oninput="editar(${i},4,this.innerText)">${dataEmp}</td>
      <td contenteditable="true" oninput="editar(${i},5,this.innerText)">${dataDev}</td>

      <td class="center">
        <input type="checkbox" ${devolvido=="Sim"?"checked":""} onclick="marcarDevolvido(${i},this.checked)">
      </td>

      <td class="center" style="cursor:pointer;font-size:18px;color:var(--danger)" onclick="removerItem(${i})">üóëÔ∏è</td>
    `;
    tbody.appendChild(tr);
  });
}

function editar(i, c, v) {
  itens[i] = itens[i] || [];
  itens[i][c] = v;
  // auto-save minor edits
  localStorage.setItem("inventarioFerramentas", JSON.stringify(itens));
}

function trocarEmprestado(i, v) {
  itens[i] = itens[i] || [];
  itens[i][2] = v;
  if (v === "Sim") {
    if (!itens[i][4]) itens[i][4] = new Date().toLocaleDateString("pt-BR");
    itens[i][6] = "N√£o";
  } else {
    itens[i][4] = "";
  }
  salvar();
  carregarTabela();
}

function marcarDevolvido(i, chk) {
  itens[i] = itens[i] || [];
  itens[i][6] = chk ? "Sim" : "N√£o";
  itens[i][5] = chk ? new Date().toLocaleDateString("pt-BR") : "";
  if (chk) {
    itens[i][2] = "N√£o";
    itens[i][4] = "";
  }
  salvar();
  carregarTabela();
}

function buscarItem(){
  let f = document.getElementById('buscar').value.toLowerCase();
  document.querySelectorAll("#tabela tbody tr").forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(f) ? "" : "none";
  });
}

/* adicionar pe√ßa via modal */
function abrirModalAdd(){
  carregarColaboradores(); // atualiza select
  document.getElementById('modal').style.display = 'flex';
  // pr√©-definir valores
  document.getElementById('inpItem').value = "";
  document.getElementById('inpQtd').value = "1";
  document.getElementById('inpEmprestado').value = "N√£o";
  document.getElementById('inpParaQuem').value = "";
}

function fecharModal(){
  document.getElementById('modal').style.display = 'none';
}

function adicionarPe√ßa(){
  const nome = document.getElementById('inpItem').value.trim();
  const qtd = document.getElementById('inpQtd').value || "1";
  const emp = document.getElementById('inpEmprestado').value;
  const para = document.getElementById('inpParaQuem').value || "";

  if(!nome){ alert("Digite o nome do item."); return; }

  const dataEmp = emp === "Sim" ? new Date().toLocaleDateString("pt-BR") : "";
  const novo = [nome, qtd, emp, para, dataEmp, "", emp === "Sim" ? "N√£o" : "N√£o"];
  itens.push(novo);
  salvar();
  carregarTabela();
  fecharModal();
}

/* marcar todos emprestados como devolvidos (exemplo de a√ß√£o em massa) */
function devolverSelecionados(){
  let changed = false;
  itens.forEach((it, idx) => {
    if(it[2] === "Sim"){
      itens[idx][2] = "N√£o";
      itens[idx][6] = "Sim";
      itens[idx][5] = new Date().toLocaleDateString("pt-BR");
      itens[idx][4] = "";
      changed = true;
    }
  });
  if(changed) { salvar(); carregarTabela(); alert("Itens emprestados marcados como devolvidos."); }
  else alert("Nenhum item marcado como emprestado.");
}

/* export/import itens (JSON helpers kept but small buttons now call Excel) */
function exportar(){
  const data = JSON.stringify(itens, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "inventarioFerramentas.json"; a.click(); URL.revokeObjectURL(url);
}

function importarPrompt(){
  const json = prompt("Cole o JSON dos itens (substitui o invent√°rio atual):");
  try{
    const parsed = JSON.parse(json);
    if(Array.isArray(parsed)){
      itens = parsed;
      localStorage.setItem("inventarioFerramentas", JSON.stringify(itens));
      carregarTabela();
      alert("Importado!");
    } else alert("JSON inv√°lido.");
  }catch(e){ alert("JSON inv√°lido."); }
}

function limparItens(){
  if(!confirm("Remover todos os itens do invent√°rio?")) return;
  itens = [];
  salvar();
  carregarTabela();
}

/* fun√ß√£o remover item (lixeira) */
function removerItem(i){
  if(!confirm("Excluir item?")) return;
  itens.splice(i,1);
  salvar();
  carregarTabela();
}

/* -----------------------
   COLABORADORES
   ----------------------- */

function salvarColaborador(){
  const nome = document.getElementById('colabNome').value.trim();
  const area = document.getElementById('colabArea').value.trim();
  const fotoInput = document.getElementById('colabFoto');

  if(!nome){ alert("Digite o nome do colaborador."); return; }

  if(fotoInput.files && fotoInput.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      colaboradores.push({name: nome, photo: e.target.result, area: area});
      persistColabs();
      limparFormColab();
      carregarColaboradores();
    };
    reader.readAsDataURL(fotoInput.files[0]);
  } else {
    colaboradores.push({name: nome, photo: "", area: area});
    persistColabs();
    limparFormColab();
    carregarColaboradores();
  }
}

function persistColabs(){
  localStorage.setItem("colaboradoresSistema", JSON.stringify(colaboradores));
}

function carregarColaboradores(){
  colaboradores = JSON.parse(localStorage.getItem("colaboradoresSistema") || "[]");
  // preencher lista visual
  const lista = document.getElementById('colaboradoresLista');
  if(lista){
    lista.innerHTML = "";
    colaboradores.forEach((c, i) => {
      const div = document.createElement('div');
      div.className = 'col-item';
      div.innerHTML = `
        <img src="${c.photo || ''}" alt="foto" onerror="this.style.display='none'">
        <div>
          <div style="font-weight:700">${c.name}</div>
          <div style="color:var(--muted);font-size:13px">${c.area || ''}</div>
        </div>
        <div class="col-actions">
          <button class="small-btn btn-muted" onclick="editarColab(${i})">Editar</button>
          <button class="small-btn btn-danger" onclick="removerColab(${i})">Remover</button>
        </div>
      `;
      lista.appendChild(div);
    });
  }

  // preencher selects "Para quem?" nos formul√°rios (modal)
  const sel = document.getElementById('inpParaQuem');
  if(sel){
    sel.innerHTML = `<option value=""></option>`;
    colaboradores.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.text = c.name + (c.area ? (" ‚Äî " + c.area) : "");
      sel.appendChild(opt);
    });
  }
}

function limparFormColab(){
  document.getElementById('colabNome').value = "";
  document.getElementById('colabArea').value = "";
  document.getElementById('colabFoto').value = "";
}

function removerColab(i){
  if(!confirm("Remover colaborador?")) return;
  colaboradores.splice(i,1);
  persistColabs();
  carregarColaboradores();
}

function editarColab(i){
  const c = colaboradores[i];
  const novoNome = prompt("Nome:", c.name);
  if(novoNome === null) return;
  const novaArea = prompt("√Årea:", c.area || "");
  if(novaArea === null) return;
  colaboradores[i].name = novoNome.trim();
  colaboradores[i].area = novaArea.trim();
  persistColabs();
  carregarColaboradores();
}

/* export/import colaboradores (JSON helpers left as-is) */
function exportarColabs(){
  const data = JSON.stringify(colaboradores, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "colaboradoresFerramentas.json"; a.click(); URL.revokeObjectURL(url);
}

function importarColabsPrompt(){
  const json = prompt("Cole o JSON dos colaboradores (substitui o atual):");
  try{
    const parsed = JSON.parse(json);
    if(Array.isArray(parsed)){
      colaboradores = parsed;
      persistColabs();
      carregarColaboradores();
      alert("Importado!");
    } else alert("JSON inv√°lido.");
  }catch(e){ alert("JSON inv√°lido."); }
}

function limparColabs(){
  if(!confirm("Remover todos os colaboradores?")) return;
  colaboradores = [];
  persistColabs();
  carregarColaboradores();
}

/* exportar tudo (itens + colaboradores) JSON helper */
function exportarTudo(){
  const data = {
    itens: itens,
    colaboradores: colaboradores
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "backup_inventario_colaboradores.json"; a.click(); URL.revokeObjectURL(url);
}

/* ========================
   EXCEL (SheetJS) FUNCTIONS
   - exportarExcel() -> cria 2 abas: 'Itens' and 'Colaboradores'
   - triggerImport() -> dispara o input hidden
   - importFromFile(files) -> l√™ o arquivo xlsx e atualiza itens & colaboradores
   ======================== */

function exportarExcel(){
  // Items sheet: Item, Qtd, Emprestado, ParaQuem, DataEmp, DataDev, Devolvido
  const itemsRows = itens.map(r => ({
    Item: r[0] ?? "",
    Qtd: r[1] ?? "",
    Emprestado: r[2] ?? "",
    ParaQuem: r[3] ?? "",
    DataEmp: r[4] ?? "",
    DataDev: r[5] ?? "",
    Devolvido: r[6] ?? ""
  }));

  // Colaboradores sheet: Nome, Area, Photo (base64)
  const colabsRows = colaboradores.map(c => ({
    Nome: c.name ?? "",
    Area: c.area ?? "",
    Photo: c.photo ?? ""
  }));

  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.json_to_sheet(itemsRows);
  XLSX.utils.book_append_sheet(wb, ws1, "Itens");

  const ws2 = XLSX.utils.json_to_sheet(colabsRows);
  XLSX.utils.book_append_sheet(wb, ws2, "Colaboradores");

  // Write file
  XLSX.writeFile(wb, "inventario_e_colaboradores.xlsx");
}

function triggerImport(){
  const inp = document.getElementById('importExcelFile');
  inp.value = null;
  inp.click();
  inp.onchange = function(){ importFromFile(this.files); };
}

function importFromFile(files){
  if(!files || !files.length) return;
  const file = files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});

      // Import Itens sheet if exists
      if(wb.SheetNames.includes("Itens")){
        const sheet = wb.Sheets["Itens"];
        const arr = XLSX.utils.sheet_to_json(sheet, {defval:""});
        // Map rows to itens format [nome,qtd,emprestado,paraquem,dataEmp,dataDev,devolvido]
        const importedItems = arr.map(row => [
          row.Item ?? "",
          row.Qtd ?? "",
          row.Emprestado ?? "",
          row.ParaQuem ?? "",
          row.DataEmp ?? "",
          row.DataDev ?? "",
          row.Devolvido ?? ""
        ]);
        // Replace current itens if user confirms
        if(confirm("Substituir itens atuais pelos itens do arquivo Excel? (Cancelar = ignorar importa√ß√£o de itens)")){
          itens = importedItems;
          localStorage.setItem("inventarioFerramentas", JSON.stringify(itens));
        }
      }

      // Import Colaboradores sheet if exists
      if(wb.SheetNames.includes("Colaboradores")){
        const sheet2 = wb.Sheets["Colaboradores"];
        const arr2 = XLSX.utils.sheet_to_json(sheet2, {defval:""});
        const importedColabs = arr2.map(row => ({
          name: row.Nome ?? "",
          area: row.Area ?? "",
          photo: row.Photo ?? ""
        }));
        if(confirm("Substituir colaboradores atuais pelos colaboradores do arquivo Excel? (Cancelar = ignorar importa√ß√£o de colaboradores)")){
          colaboradores = importedColabs;
          localStorage.setItem("colaboradoresSistema", JSON.stringify(colaboradores));
        }
      }

      // Refresh UI
      carregarColaboradores();
      carregarTabela();
      alert("Importa√ß√£o conclu√≠da (verifique se substituiu listas quando solicitado).");
    }catch(err){
      console.error(err);
      alert("Erro ao importar Excel. Verifique o arquivo.");
    }
  };
  reader.readAsArrayBuffer(file);
}

/* Inicializa√ß√£o */
document.addEventListener('DOMContentLoaded', ()=>{
  carregarColaboradores();
  carregarTabela();
});
</script>
</body>
</html>

